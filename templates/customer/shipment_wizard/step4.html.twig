{% extends 'customer/shipment_wizard/base.html.twig' %}

{% block wizard_content %}
<div class="fade-in" x-data="step4Data()">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Courier Selection -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-truck mr-2 text-blue-600"></i>Choose Courier Service
                </h2>

                <div class="space-y-4">
                    {% for courier in courier_options %}
                    <div class="courier-option border-2 rounded-lg p-4 transition-all"
                         :class="selectedCourier === '{{ courier.courier_code }}' ? 'selected border-blue-500' : 'border-gray-200'"
                         @click="selectCourier('{{ courier.courier_code }}', {{ courier.price }})">

                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="flex-shrink-0">
                                    <img src="{{ courier.logo_url }}"
                                         alt="{{ courier.courier_name }}"
                                         class="w-16 h-12 object-contain">
                                </div>

                                <div>
                                    <h3 class="font-semibold text-lg">{{ courier.courier_name }}</h3>
                                    <p class="text-sm text-gray-600">{{ courier.service_type|title }} • {{ courier.delivery_time }}</p>

                                    <div class="flex items-center space-x-4 mt-2">
                                        {% for feature in courier.features %}
                                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">{{ feature }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600">{{ courier.price }} {{ courier.currency }}</div>
                                {% if courier.recommended %}
                                <div class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mt-1">Recommended</div>
                                {% endif %}
                                <div class="text-xs text-gray-500 mt-1">
                                    Base: {{ courier.base_price }} + Services: {{ courier.additional_services_price }}
                                </div>
                            </div>
                        </div>

                        <!-- InPost Service Points -->
                        {% if courier.courier_code == 'inpost' and courier.service_points is defined %}
                        <div class="mt-4 border-t pt-4" x-show="selectedCourier === 'inpost'">
                            <h4 class="font-medium mb-2">Choose InPost Point:</h4>
                            <div class="max-h-40 overflow-y-auto space-y-2">
                                {% for point in courier.service_points %}
                                <div class="flex items-center p-2 border rounded cursor-pointer hover:bg-gray-50"
                                     @click="selectInPostPoint('{{ point.name }}', '{{ point.address }}')">
                                    <input type="radio"
                                           name="inpost_point"
                                           value="{{ point.name }}"
                                           x-model="selectedInPostPoint"
                                           class="mr-3">
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">{{ point.name }}</div>
                                        <div class="text-xs text-gray-600">{{ point.address }}</div>
                                        <div class="text-xs text-green-600">{{ point.distance }}m away</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <div x-show="errors.courier_selection" class="form-error mt-2" x-text="errors.courier_selection"></div>
            </div>

            <!-- Payment Method -->
            <div class="bg-white rounded-lg shadow-md p-6" x-show="selectedCourier">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-credit-card mr-2 text-blue-600"></i>Payment Method
                </h2>

                <div class="space-y-4">
                    <!-- Account Balance -->
                    <div class="border-2 rounded-lg p-4 transition-colors"
                         :class="paymentMethod === 'balance' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'"
                         @click="selectPaymentMethod('balance')">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input type="radio"
                                       x-model="paymentMethod"
                                       value="balance"
                                       id="payment_balance"
                                       class="mr-3">
                                <label for="payment_balance" class="cursor-pointer">
                                    <div class="font-medium">Account Balance</div>
                                    <div class="text-sm text-gray-600">Use funds from your account balance</div>
                                </label>
                            </div>
                            <div class="text-right">
                                <div class="font-medium">{{ customer_balance }} PLN</div>
                                <div class="text-xs"
                                     :class="accountBalance >= totalPrice ? 'text-green-600' : 'text-red-600'">
                                    <span x-text="accountBalance >= totalPrice ? 'Sufficient funds' : 'Insufficient funds'"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Credit Card -->
                    <div class="border-2 rounded-lg p-4 transition-colors"
                         :class="paymentMethod === 'card' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'"
                         @click="selectPaymentMethod('card')">
                        <div class="flex items-center">
                            <input type="radio"
                                   x-model="paymentMethod"
                                   value="card"
                                   id="payment_card"
                                   class="mr-3">
                            <label for="payment_card" class="cursor-pointer">
                                <div class="font-medium">Credit/Debit Card</div>
                                <div class="text-sm text-gray-600">Pay securely with your card</div>
                            </label>
                        </div>
                    </div>

                    <!-- Bank Transfer -->
                    <div class="border-2 rounded-lg p-4 transition-colors"
                         :class="paymentMethod === 'transfer' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'"
                         @click="selectPaymentMethod('transfer')">
                        <div class="flex items-center">
                            <input type="radio"
                                   x-model="paymentMethod"
                                   value="transfer"
                                   id="payment_transfer"
                                   class="mr-3">
                            <label for="payment_transfer" class="cursor-pointer">
                                <div class="font-medium">Bank Transfer</div>
                                <div class="text-sm text-gray-600">Pay via online banking (PayNow)</div>
                            </label>
                        </div>
                    </div>
                </div>

                <div x-show="errors.payment_method" class="form-error mt-2" x-text="errors.payment_method"></div>
            </div>

            <!-- Terms and Conditions -->
            <div class="bg-white rounded-lg shadow-md p-6" x-show="selectedCourier">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-file-contract mr-2 text-blue-600"></i>Terms and Conditions
                </h3>

                <div class="space-y-3">
                    <div class="flex items-start">
                        <input type="checkbox"
                               x-model="acceptedTerms"
                               @change="validateField('terms', $event.target.checked)"
                               id="accept_terms"
                               class="mt-1 rounded">
                        <label for="accept_terms" class="ml-3 text-sm cursor-pointer">
                            I accept the <a href="#" class="text-blue-600 hover:underline">Terms and Conditions</a>
                            and <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a>
                        </label>
                    </div>

                    <div class="flex items-start">
                        <input type="checkbox"
                               x-model="acceptedCourierTerms"
                               @change="validateField('courier_terms', $event.target.checked)"
                               id="accept_courier_terms"
                               class="mt-1 rounded">
                        <label for="accept_courier_terms" class="ml-3 text-sm cursor-pointer">
                            I accept the courier service terms and conditions
                        </label>
                    </div>

                    <div class="flex items-start">
                        <input type="checkbox"
                               x-model="marketingConsent"
                               id="marketing_consent"
                               class="mt-1 rounded">
                        <label for="marketing_consent" class="ml-3 text-sm cursor-pointer">
                            I agree to receive marketing communications (optional)
                        </label>
                    </div>
                </div>

                <div x-show="errors.terms" class="form-error mt-2" x-text="errors.terms"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Order Summary -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-receipt mr-2 text-blue-600"></i>Order Summary
                </h3>

                <div class="space-y-3">
                    <!-- Package Details -->
                    <div class="border-b pb-3">
                        <div class="text-sm font-medium text-gray-900 mb-1">Package Details</div>
                        <div class="text-sm text-gray-600" x-text="packageSummary"></div>
                    </div>

                    <!-- Route -->
                    <div class="border-b pb-3">
                        <div class="text-sm font-medium text-gray-900 mb-1">Route</div>
                        <div class="text-sm text-gray-600" x-text="routeSummary"></div>
                    </div>

                    <!-- Selected Courier -->
                    <div class="border-b pb-3" x-show="selectedCourier">
                        <div class="text-sm font-medium text-gray-900 mb-1">Courier Service</div>
                        <div class="text-sm text-gray-600" x-text="getSelectedCourierName()"></div>
                        <div class="text-xs text-gray-500" x-text="getSelectedCourierService()"></div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Base shipping:</span>
                            <span x-text="baseShippingPrice.toFixed(2) + ' PLN'"></span>
                        </div>
                        <div class="flex justify-between text-sm" x-show="additionalServicesPrice > 0">
                            <span class="text-gray-600">Additional services:</span>
                            <span x-text="additionalServicesPrice.toFixed(2) + ' PLN'"></span>
                        </div>
                        <div class="flex justify-between text-sm" x-show="vatAmount > 0">
                            <span class="text-gray-600">VAT (23%):</span>
                            <span x-text="vatAmount.toFixed(2) + ' PLN'"></span>
                        </div>

                        <hr class="my-2">

                        <div class="flex justify-between font-semibold text-lg">
                            <span>Total:</span>
                            <span class="text-blue-600" x-text="totalPrice.toFixed(2) + ' PLN'"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="bg-white rounded-lg shadow-md p-6" x-show="paymentMethod">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-money-check-alt mr-2 text-green-600"></i>Payment Summary
                </h3>

                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Payment method:</span>
                        <span class="font-medium" x-text="getPaymentMethodName()"></span>
                    </div>

                    <div x-show="paymentMethod === 'balance'">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Current balance:</span>
                            <span x-text="accountBalance.toFixed(2) + ' PLN'"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">After payment:</span>
                            <span :class="accountBalance - totalPrice >= 0 ? 'text-green-600' : 'text-red-600'"
                                  x-text="(accountBalance - totalPrice).toFixed(2) + ' PLN'"></span>
                        </div>
                    </div>

                    <div x-show="paymentMethod === 'card'" class="text-sm text-gray-600">
                        You will be redirected to secure payment gateway
                    </div>

                    <div x-show="paymentMethod === 'transfer'" class="text-sm text-gray-600">
                        You will be redirected to PayNow for bank transfer
                    </div>
                </div>
            </div>

            <!-- Delivery Estimate -->
            <div class="bg-blue-50 rounded-lg p-6" x-show="selectedCourier">
                <h3 class="text-lg font-semibold text-blue-900 mb-3">
                    <i class="fas fa-clock mr-2"></i>Delivery Estimate
                </h3>
                <div class="text-sm text-blue-800">
                    <div class="mb-2">
                        <strong>Pickup:</strong> <span x-text="getPickupEstimate()"></span>
                    </div>
                    <div>
                        <strong>Delivery:</strong> <span x-text="getDeliveryEstimate()"></span>
                    </div>
                </div>
            </div>

            <!-- Help -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">
                    <i class="fas fa-question-circle mr-2"></i>Need Help?
                </h3>
                <div class="text-sm text-gray-700 space-y-2">
                    <p><strong>Courier Selection:</strong> Choose based on price, delivery time, and features.</p>
                    <p><strong>Payment:</strong> Account balance is the fastest option if you have sufficient funds.</p>
                    <p><strong>InPost:</strong> Select a convenient pickup point for the recipient.</p>
                </div>
                <div class="mt-3">
                    <a href="#" class="text-blue-600 hover:underline text-sm">
                        <i class="fas fa-phone mr-1"></i>Contact Support
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function step4Data() {
    return {
        selectedCourier: '',
        selectedCourierPrice: 0,
        selectedInPostPoint: '',
        paymentMethod: '',
        acceptedTerms: false,
        acceptedCourierTerms: false,
        marketingConsent: false,
        accountBalance: {{ customer_balance }},
        baseShippingPrice: 0,
        additionalServicesPrice: {{ wizard_data.step3.total_additional_cost ?? 0 }},
        vatAmount: 0,
        totalPrice: 0,
        errors: {},

        courierOptions: {{ courier_options|json_encode|raw }},
        wizardData: {{ wizard_data|json_encode|raw }},

        selectCourier(courierCode, price) {
            this.selectedCourier = courierCode;
            this.selectedCourierPrice = price;
            this.calculateTotalPrice();
            this.validateField('courier_selection', courierCode);
        },

        selectInPostPoint(pointName, pointAddress) {
            this.selectedInPostPoint = pointName;
        },

        selectPaymentMethod(method) {
            this.paymentMethod = method;
            this.validateField('payment_method', method);
        },

        calculateTotalPrice() {
            if (!this.selectedCourier) {
                this.totalPrice = 0;
                return;
            }

            const courier = this.courierOptions.find(c => c.courier_code === this.selectedCourier);
            if (courier) {
                this.baseShippingPrice = parseFloat(courier.base_price);
                const servicesPrice = parseFloat(courier.additional_services_price);

                const subtotal = this.baseShippingPrice + servicesPrice + this.additionalServicesPrice;
                this.vatAmount = subtotal * 0.23; // 23% VAT
                this.totalPrice = subtotal + this.vatAmount;
            }
        },

        getSelectedCourierName() {
            const courier = this.courierOptions.find(c => c.courier_code === this.selectedCourier);
            return courier ? courier.courier_name : '';
        },

        getSelectedCourierService() {
            const courier = this.courierOptions.find(c => c.courier_code === this.selectedCourier);
            return courier ? `${courier.service_type} • ${courier.delivery_time}` : '';
        },

        getPaymentMethodName() {
            const methods = {
                'balance': 'Account Balance',
                'card': 'Credit/Debit Card',
                'transfer': 'Bank Transfer'
            };
            return methods[this.paymentMethod] || '';
        },

        getPickupEstimate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toLocaleDateString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'short'
            });
        },

        getDeliveryEstimate() {
            const courier = this.courierOptions.find(c => c.courier_code === this.selectedCourier);
            if (!courier) return '';

            const deliveryTime = courier.delivery_time;
            let days = 1;

            if (deliveryTime.includes('1-2')) days = 2;
            else if (deliveryTime.includes('1-3')) days = 3;
            else if (deliveryTime.includes('2-3')) days = 3;

            const deliveryDate = new Date();
            deliveryDate.setDate(deliveryDate.getDate() + days);

            return deliveryDate.toLocaleDateString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'short'
            });
        },

        collectStepData() {
            return {
                selected_courier: this.selectedCourier,
                selected_price: this.totalPrice,
                currency: 'PLN',
                payment_method: this.paymentMethod,
                inpost_point: this.selectedInPostPoint,
                accepted_terms: this.acceptedTerms,
                accepted_courier_terms: this.acceptedCourierTerms,
                marketing_consent: this.marketingConsent,
                price_breakdown: {
                    base_shipping: this.baseShippingPrice,
                    additional_services: this.additionalServicesPrice,
                    vat: this.vatAmount,
                    total: this.totalPrice
                }
            };
        },

        validateField(fieldName, value) {
            if (this.errors[fieldName] && value) {
                delete this.errors[fieldName];
            }
        },

        init() {
            // Set package and route summaries from wizard data
            this.packageSummary = this.getPackageSummary();
            this.routeSummary = this.getRouteSummary();

            // Auto-select payment method based on balance
            if (this.accountBalance >= 100) { // Assume minimum order
                this.paymentMethod = 'balance';
            }
        },

        getPackageSummary() {
            const step1 = this.wizardData.step1;
            if (!step1) return 'Package details';

            return `${step1.weight_kg}kg • ${step1.package_type} • ${step1.items?.length || 1} item(s)`;
        },

        getRouteSummary() {
            const step2 = this.wizardData.step2;
            if (!step2) return 'Route details';

            return `${step2.sender?.city || 'Unknown'} → ${step2.recipient?.city || 'Unknown'}`;
        }
    }
}
</script>
{% endblock %}